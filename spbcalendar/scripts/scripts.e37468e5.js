"use strict";angular.module("spbtvcalendarApp",["ngStorage"]).run(["$rootScope",function(a){a._=window._}]);var SpbTVCalendar=SpbTVCalendar||{};SpbTVCalendar.helpers={HorizontallyBound:function(a,b){var c=a[0].getBoundingClientRect(),d=b[0].getBoundingClientRect();return c.left<=d.left&&c.right>=d.right}},angular.module("spbtvcalendarApp").controller("CalendarCtrl",["$scope","EventCalendar","EventService",function(a,b,c){function d(){a.displayDates=e()}function e(){return _.chunk(a.cal.getDatesForMonthDisplay(),a.cal.daysOfTheWeek.length)}a.cal=new b,d(),a.nextMonth=function(){a.cal.nextMonth(),d()},a.prevMonth=function(){a.cal.prevMonth(),d()},a.addEvent=function(a,b){return c.addEvent(a,b)},a.removeEvent=function(a,b){c.removeEvent(a.id,b)}}]),angular.module("spbtvcalendarApp").factory("EventCalendar",["EventService",function(a){function b(){this.currentDate=new Date,this.currentDate.setHours(0,0,0,0),this.currentMonth=this.currentDate.getMonth(),this.currentYear=this.currentDate.getFullYear(),this.daysOfTheWeek=d}var c=["January","February","March","April","May","June","July","August","September","October","November","December"],d=["Sun","Mon","Tues","Wed","Thu","Fri","Sat"],e=7,f=6,g=e*f;return b.prototype.getDatesForMonthDisplay=function(){for(var b=new Date(this.currentYear,this.currentMonth,1),c=new Date(this.currentYear,this.currentMonth+1,0),d=b.getDay(),f=e-(c.getDay()+1),h=[],i=1;i<=c.getDate();i++){var j=new Date(this.currentYear,this.currentMonth,i);j.currentMonthDate=!0,j.getTime()===this.currentDate.getTime()&&(j.currentDate=!0),h.push(j)}var k=f+(g-(d+f+h.length)),l=this.extendByDays(d,k,h);return _.forEach(l,function(b){b.events=a.getEvents(b)}),l},b.prototype.nextMonth=function(){var a=this.increaseMonth(this.currentMonth,this.currentYear);this.currentYear=a.getFullYear(),this.currentMonth=a.getMonth()},b.prototype.prevMonth=function(){var a=this.decreaseMonth(this.currentMonth,this.currentYear);this.currentYear=a.getFullYear(),this.currentMonth=a.getMonth()},b.prototype.getMonthName=function(){return c[this.currentMonth]},b.prototype.extendByDays=function(a,b,c){var d=[],e=[],f=c[0],g=this.decreaseMonth(f.getMonth(),f.getFullYear()),h=this.increaseMonth(f.getMonth(),f.getFullYear()),i=this.getDaysInMonth(g.getMonth(),g.getFullYear());if(a>0){for(var j=0;a>j;j++)d.push(new Date(g.getFullYear(),g.getMonth(),i-j));d.reverse()}if(b>0)for(var k=1;b>=k;k++)e.push(new Date(h.getFullYear(),h.getMonth(),k));var l=d.concat(c);return l=l.concat(e)},b.prototype.increaseMonth=function(a,b){return++a>11&&(a=0,b++),new Date(b,a)},b.prototype.decreaseMonth=function(a,b){return--a<0&&(a=11,b--),new Date(b,a)},b.prototype.getDaysInMonth=function(a,b){return new Date(b,a+1,0).getDate()},b}]),angular.module("spbtvcalendarApp").directive("calDate",["$compile",function(a){return{templateUrl:"partials/directives/date.directive.html",restrict:"A",link:function(a,b){a.dateElem=b},controller:["$scope",function(b){b.toggleEventWindow=function(){a($("<events-window></events-window>"))(b)}}]}}]),angular.module("spbtvcalendarApp").factory("EventService",["$localStorage","dateFilter",function(a,b){function c(){return void 0==a.lastEventId&&(a.lastEventId=0),++a.lastEventId}function d(a){return a instanceof Date?b(a,"dd/MM/yyyy"):a}var e={};return e.getEvents=function(b){var c=d(b);return angular.fromJson(a[c])||[]},e.saveEvents=function(b,c){var e=d(c);a[e]=angular.toJson(b)},e.addEvent=function(a,b){var e=d(b);return a.id=c(),this.saveEvent(a,e),a},e.saveEvent=function(a,b){var c=d(b),e=this.getEvents(c);e||(e=[]),_.remove(e,{id:a.id}),e.push(a),this.saveEvents(e,c)},e.removeEvent=function(b,c){var e=d(c),f=this.getEvents(e);if(!f)return!1;var g=_.remove(f,{id:b}).length>0;return g&&(f.length>0?this.saveEvents(f,e):delete a[e]),g},e}]),angular.module("spbtvcalendarApp").directive("eventsWindow",function(){return{templateUrl:"partials/directives/events-window.directive.html",restrict:"E",replace:!0,link:function(a,b){var c=$(b),d=$(a.dateElem),e=$("#events-window");if(e.length){if(d.find(e).length)return void e.remove();e.remove()}d.append(c),SpbTVCalendar.helpers.HorizontallyBound(c.closest("table"),c)||c.addClass("float-left"),c.detach().appendTo(d),c.find("textarea").focus()},controller:["$scope",function(a){a.newEvent={},a.remove=function(b){a.removeEvent(b,a.date),_.remove(a.date.events,b)},a.add=function(){a.newEvent=a.addEvent(a.newEvent,a.date),a.date.events.push(angular.copy(a.newEvent)),a.newEvent={}},a.submitForm=function(){a.eventForm.newEvent.$valid&&(a.add(),a.eventForm.$setPristine(),a.$apply())}}]}}),angular.module("spbtvcalendarApp").directive("ctrlEnter",function(){return{restrict:"A",link:function(a,b,c){var d=[];b.bind("keydown keyup",function(b){d[b.keyCode]="keydown"==b.type,d[17]&&d[13]&&a.$eval(c.ctrlEnter)})}}}),angular.module("spbtvcalendarApp").directive("eventsList",function(){return{templateUrl:"partials/directives/events-list.directive.html",restrict:"E",replace:!0,scope:!0,link:function(a,b,c){a.events=a.$eval(c.events),a.fullList=a.$eval(c.fullList),a.remove=a.$eval(c.remove),a.limit=a.$eval(c.limit)},controller:["$scope",function(a){var b=11;a.getTitle=function(a){return a=a||"",a.length>b?a.slice(0,b)+"...":a}}]}});